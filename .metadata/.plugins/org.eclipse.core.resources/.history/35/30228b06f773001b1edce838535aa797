package com.globits.PI.repository;

import java.util.List;
import java.util.UUID;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import com.globits.PI.domain.Reagent;
import com.globits.PI.dto.ReagentDto;
import com.globits.PI.dto.ReportSimilarityReagentDto;

@Repository
public interface ReagentRepository extends JpaRepository<Reagent, UUID> {

	@Query("select entity FROM Reagent entity where entity.code =?1 ")
	Reagent getByCode(String code);

	@Query("select new com.globits.PI.dto.ReagentDto(entity) FROM Reagent entity ")
	List<ReagentDto> getAll();


	
	@Query("select new com.globits.PI.dto.ReportSimilarityReagentDto(r.id,erd.sampleTube.eqaSample.id,erd.result,r.name,erd.sampleTube.eqaSample.code) "
				+ "from EQAResultReport as entity left join EQAResultReportDetail as erd on erd.resultReport.id = entity.id "
				+ " left join Reagent as r on r.id = entity.reagent.id "
				+ "where entity.healthOrgRound.healthOrg.isManagementUnit is true and entity.healthOrgRound.round.id =?1 ")
	List<ReportSimilarityReagentDto>getAllReportReagentByManagementUnit(UUID roundId);
	
	@Query("select new com.globits.PI.dto.ReportSimilarityReagentDto(entity.reagent.id,entity.reagent.name) "
			+ "from EQAResultReport as entity join EQAResultReportDetail as erd on erd.resultReport.id = entity.id "
			+ "where entity.healthOrgRound.healthOrg.isManagementUnit is true and entity.healthOrgRound.round.id =?1 group by entity.reagent.id ")
List<ReportSimilarityReagentDto>getReportReagentByManagementUnit(UUID roundId);
	
	@Query("select new com.globits.PI.dto.ReportSimilarityReagentDto(erd.sampleTube.eqaSample.id,erd.sampleTube.eqaSample.code,erd.result,entity.reagent.id) "
			+ "from EQAResultReport as entity join EQAResultReportDetail as erd on erd.resultReport.id = entity.id "
			+ "where entity.healthOrgRound.healthOrg.isManagementUnit is true and entity.healthOrgRound.round.id =?1 group by erd.sampleTube.eqaSample.id ")
List<ReportSimilarityReagentDto>getReportSampleByManagementUnit(UUID roundId);
}
